version: 2
jobs:
  build:
    docker:
      - image: circleci/node:chakracore-8.11.1
    working_directory: ~/repo
    steps:
      - checkout
      - add_ssh_keys:
          fingerprints:
            - "50:d0:85:97:f2:e4:9a:7c:0e:77:0f:55:8d:af:0b:fe"
            - checkout
      - run:
          name: Adding host to knownhost
          command: ssh-keyscan -H 44.201.255.101 >> ~/.ssh/known_hosts
      - run:
          name: AWS EC2 deploy
          command: |
            ssh -o StrictHostKeyChecking=no ec2-user@44.201.255.101
            "echo Start deploy
            scp -r -o StrictHostKeyChecking=no index.php ec2-user@44.201.255.101:/home/ubuntu/index.php
            ssh ec2-user@44.201.255.101 'sudo mv /home/ubuntu/index.php usr/share/nginx/html/> dev/null &'
            echo "deployment done"