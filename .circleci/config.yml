version: 2
jobs:
  build:
    docker:
      - image: circleci/node:chakracore-8.11.1
    working_directory: ~/repo
    steps:
      - checkout
      - add_ssh_keys:
          fingerprints:
            - "77:b3:dc:a8:b1:f6:8c:52:81:02:07:46:07:cb:97:f3"
            - checkout
      - run:
          name: Adding host to knownhost
          command: ssh-keyscan -H 54.147.236.31 >> ~/.ssh/known_hosts
      - run:
          name: AWS EC2 deploy
          command: |
            ssh -o StrictHostKeyChecking=no ec2-user@54.147.236.31
            "echo Start deploy
            scp -r -o StrictHostKeyChecking=no index.php ec2-user@54.147.236.31:/home/ec2-user/index.php
            ssh ec2-user@54.147.236.31 'sudo mv /home/ec2-user/index.php /usr/share/nginx/html/> dev/null &'
            echo "deployment done"